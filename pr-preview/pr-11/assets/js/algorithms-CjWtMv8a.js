const f={IMG_SIZE:500,SCALE:20,N_PINS:288,MAX_LINES:4e3,LINE_WEIGHT:20,MIN_DISTANCE:20,HOOP_DIAMETER:.625},y={RED:.299,GREEN:.587,BLUE:.114};function E(n,e=f.IMG_SIZE){const t=document.createElement("canvas"),i=t.getContext("2d");t.width=e,t.height=e;const{width:o,height:c}=n;let r,s,a=0,l=0;return c>o?(r=o,s=o,l=Math.floor((c-o)/2)):o>c?(r=c,s=c,a=Math.floor((o-c)/2)):(r=o,s=c),i.drawImage(n,a,l,r,s,0,0,e,e),i.getImageData(0,0,e,e)}function P(n,e={red:y.RED,green:y.GREEN,blue:y.BLUE}){const t=document.createElement("canvas"),i=t.getContext("2d");t.width=n.width,t.height=n.height;const o=i.createImageData(n.width,n.height),c=o.data,r=n.data;for(let s=0;s<r.length;s+=4){const a=r[s],l=r[s+1],h=r[s+2],g=r[s+3],u=Math.round(e.red*a+e.green*l+e.blue*h);c[s]=u,c[s+1]=u,c[s+2]=u,c[s+3]=g}return o}function S(n){const e=document.createElement("canvas"),t=e.getContext("2d");return e.width=n.width,e.height=n.height,t.putImageData(n,0,0),t.globalCompositeOperation="destination-in",t.beginPath(),t.arc(n.width/2,n.height/2,n.width/2,0,Math.PI*2),t.closePath(),t.fill(),t.getImageData(0,0,n.width,n.height)}function A(n,e=f.IMG_SIZE){const t=E(n,e),i=P(t),o=S(i);return{originalImage:n,croppedImage:{data:t.data,width:t.width,height:t.height},grayscaleImage:{data:i.data,width:i.width,height:i.height},circularMaskedImage:{data:o.data,width:o.width,height:o.height},dimensions:{width:e,height:e}}}function L(n){const{width:e,height:t,data:i}=n,o=new Uint8Array(e*t);for(let c=0;c<e*t;c++)o[c]=i[c*4];return o}function w(n,e){const t=e[0]-n[0],i=e[1]-n[1];return Math.sqrt(t*t+i*i)}function _(n,e,t){const i=[];for(let o=0;o<n;o++){const c=2*Math.PI*o/n,r=Math.floor(e+t*Math.cos(c)),s=Math.floor(e+t*Math.sin(c));i.push([r,s])}return i}function b(n={}){const{numberOfPins:e=f.N_PINS,imgSize:t=f.IMG_SIZE}=n,i=t/2,o=t/2-.5;return _(e,i,o)}function T(n,e,t){return(n+e)%t}function O(n,e,t,i=[]){const o=[];for(let c=e;c<t-e;c++){const r=T(n,c,t);i.includes(r)||o.push(r)}return o}function x(n,e,t){const i=typeof t>"u"?Math.max(Math.round(e-n)+1,1):t;if(i<2)return i===1?[n]:[];const o=new Array(i),c=(e-n)/(i-1);for(let r=0;r<i;r++)o[r]=Math.floor(n+c*r);return o}function N(n,e=f.MIN_DISTANCE){const t=n.length,i={x:new Array(t*t).fill(null),y:new Array(t*t).fill(null),length:new Array(t*t).fill(0),weight:new Array(t*t).fill(1)};for(let o=0;o<t;o++)for(let c=o+e;c<t;c++){const[r,s]=n[o],[a,l]=n[c],h=Math.floor(w(n[o],n[c])),g=x(r,a,h),u=x(s,l,h),d=o*t+c,I=c*t+o;i.x[d]=g,i.x[I]=g,i.y[d]=u,i.y[I]=u,i.length[d]=h,i.length[I]=h}return i}function p(n,e,t){const{x:i,y:o}=e;let c=0;for(let r=0;r<i.length;r++){const s=o[r]*t+i[r];s>=0&&s<n.length&&(c+=n[s])}return c}function D(n,e,t,i){const{x:o,y:c}=e;for(let r=0;r<o.length;r++){const s=c[r]*i+o[r];if(s>=0&&s<n.length){let a=n[s]-t;a<0&&(a=0),a>255&&(a=255),n[s]=a}}}function k(n,e,t,i,o){let c=-1,r=-1;const s=O(n,o.minDistance,o.numberOfPins,i);for(const a of s){const l=a*o.numberOfPins+n,h=t.x[l],g=t.y[l];if(h&&g){const u=p(e,{x:h,y:g},o.imgSize)*t.weight[l];u>c&&(c=u,r=a)}}return{bestPin:r,error:c}}async function G(n,e,t,i,o){const c=[];let r=0,s=0;const a=[];c.push(r);for(let l=0;l<i.numberOfLines;l++){const{bestPin:h}=k(r,n,t,a,i);if(h===-1){console.warn("No valid next pin found, stopping optimization");break}c.push(h);const g=h*i.numberOfPins+r,u=t.x[g],d=t.y[g];u&&d&&D(n,{x:u,y:d},i.lineWeight,i.imgSize);const I=w(e[r],e[h]);if(s+=i.hoopDiameter/i.imgSize*I,a.push(h),a.length>20&&a.shift(),r=h,o&&(l%10===0||l===i.numberOfLines-1)){console.log(`Line ${l+1}/${i.numberOfLines}: Calling progress callback`);const m={linesDrawn:l+1,totalLines:i.numberOfLines,percentComplete:(l+1)/i.numberOfLines*100,currentPin:r,nextPin:h,threadLength:s};o(m,[...c],e),await new Promise(M=>setTimeout(M,0))}}return{lineSequence:c,totalThreadLength:s}}function v(n,e){const t=new Float32Array(e*e);for(let i=0;i<n.length;i++)t[i]=255-n[i];return t}function C(n){const{type:e,ticketNo:t,nm:i,ply:o,tex:c,dtex:r,denier:s,meters:a,grams:l}=n,h=o||1;switch(e){case"tex":return c||0;case"dtex":return(r||0)*h/10;case"denier":return(s||0)*h/9;case"nm":return!i||i===0?0:1e3*h/i;case"length_weight":return!a||a===0?0:(l||0)/a*1e3;case"ticket":return!t||t===0?0:3e3/t;case"diameter_mm":return 0;default:return 0}}function W(n){const{type:e,material:t,diameterMM:i,overrideDiameterMM:o}=n;if(o&&o>0)return o;if(e==="diameter_mm")return i||0;const c=C(n);if(c<=0)return 0;let r=1380;switch(t){case"cotton":r=1540;break;case"nylon":r=1140;break;case"polyester":case"unknown":default:r=1380;break}const a=c*1e-6/r;return 2*Math.sqrt(a/Math.PI)*1e3}function H(n){const e=W(n),t=n.k||1.1;return e*t}function R(n,e,t){if(t<=0||e<=0)return 1;const i=e/t,o=n/i*255;return Math.max(1,Math.min(255,Math.round(o)))}async function z(n,e={},t){const i=Date.now();let o=e.lineWeight??f.LINE_WEIGHT;if(e.yarnSpec){const I=H(e.yarnSpec),m=e.hoopDiameter??f.HOOP_DIAMETER*25.4,M=e.imgSize??f.IMG_SIZE;o=R(I,m,M)}const c={numberOfPins:e.numberOfPins??f.N_PINS,numberOfLines:e.numberOfLines??f.MAX_LINES,lineWeight:o,minDistance:e.minDistance??f.MIN_DISTANCE,imgSize:e.imgSize??f.IMG_SIZE,scale:e.scale??f.SCALE,hoopDiameter:e.hoopDiameter??f.HOOP_DIAMETER*25.4,yarnSpec:e.yarnSpec};console.log("Processing image...");const r=A(n,c.imgSize);console.log("Calculating pin positions...");const s=b(c);console.log("Precalculating lines...");const a=N(s,c.minDistance);console.log("Creating error matrix...");const l=L({data:r.circularMaskedImage.data,width:r.circularMaskedImage.width,height:r.circularMaskedImage.height}),h=v(l,c.imgSize);console.log("Optimizing string art...");const{lineSequence:g,totalThreadLength:u}=await G(h,s,a,c,t),d=Date.now()-i;return{lineSequence:g,pinCoordinates:s,totalThreadLength:u,parameters:c,processingTimeMs:d}}export{H as a,R as b,W as c,z as g,C as n};
//# sourceMappingURL=algorithms-CjWtMv8a.js.map
